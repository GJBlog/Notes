## 运输层

### 运输层的位置

* 它向上面的应用层提供通信服务，属于面向通信部分的最高层，同时也是用户功能中的最低层
* 真正进行通信的实体是在主机中的进程，是这个主机中的一个进程和两一个主机中的一个进程在交换数据(通信)，所以严格说，两个主机进行通信就是两个主机中的应用进程互相通信。

### 运输层的很重要功能

* 复用：指在发送方不同的应用进程都可以使用同一个运输层协议传送数据
* 分用：指接收方的运输层在剥去报文的首部后能够把这些数据正确交付到目的应用进程

### 运输层协议

#### 面向连接的TCP协议

* 名称：传输控制协议(Transmission Control Protocl)
* 提供一条全双工的可靠信道
* 数据单位：按照OSI(开放系统互联基本参考模型),叫运输协议数据单元TPDU(Transport Protocol DAta Unit);在TCP/IP体系中，叫TCP报文段
* TCP的特点
    * 面向连接的运输层协议，使用前先建立连接，传送数据完毕，释放建立的连接
    * 每条TCP连接只能有两个端点(endpoint),每一条TCP连接只能是点对点的(一对一的)
    * 提供可靠交付的服务，使用TCP连接传送的数据，无差错、不丢失、不重复、按序到达
    * 提供全双工通信，允许通信双方的应用进程在任何时候都能发送数据，连接两端设有发送、接收缓存
    * 面向字节流，流指的是流入到进程或者从进程流出的字节序列
    * TCP连接的端点叫做套接字(socket)/插口，所谓套接字：IP地址:端口号,每一条TCP连接唯一地被通信两端的两个端点所确定
      ```
      TCP连接 = {socket1, socket2} = {(IP1:port1),(IP2:port2)}
      ```
* 可靠传输原理

    * 停止等待协议
    * 连续ARQ协议
        * 发送方每收到一个确认，就把发送窗口向前滑动一个分组的位置

* TCP报文段首部格式
    
    * 首部
        * 固定部分：前20个字节是固定的，首部最小长度 >= 20字节
            * 源端口：2个字节
            * 目的端口：2个字节
            * 序号(报文段序号)：4个字节,范围：[0， 2的32次方 - 1]，指：本报文段所发送的数据的第一个字节的序号.一个TCP连接中传送的字节流中的每一个字节都是按顺序编号
            * 确认号：4个字节，指：期望收到对方下一个报文段的第一个数据字节的序号。
            ```
            若确认号=N，则表明：到序号N-1为止的所有数据都已正确收到
            ```
            * 数据偏移：占4位，指：TCP报文段的数据起始处距离TCP报文段的起始处有多远(实际上是指出TCP报文段的首部长度)，单位是：32位字(即以4字节长的字)，最大值是60字节，这也是TCP首部的最大长度
            * 保留：占6位，目前为0
            * 紧急URG(URGent)
            * 确认ACK(ACKnowlegment)
            * 推送PSH(PuSH)
            * 复位RST(ReSeT)：重建位/重置位
            * 同步SYN(SYNchronization)：在连接建立时用来同步序号，当SYN=1而ACK=0,表明是一个连接请求报文段。对方若同意建立连接，则应在响应的报文段中使用SYN=1,ACK=1，所以SYN=1表示是一个连接请求或连接接受报文
            * 终止FIN：用来释放一个连接。当FIN=1，表示此报文段的发送方的数据已经发送完毕，并要求释放运输连接
            * 窗口：2个字节，窗口值[0,2的16次方-1]，指：发送本报文段的一方的接收窗口，作用：告诉对方，从本报文段首部中的确认号算起，接收方目前允许对方发送的数据量。
            ```
            窗口字段明确指出了现在允许对方发送的数据量，窗口值是经常变动的
            ```
            * 校验和：2个字节，校验和字段校验的范围包含首部 + 数据，依然在计算校验和时在TCP报文段前面添加12个字节的伪首部，并把伪首部的第4个字节17改为6(TCP的协议号)
            * 紧急指针：2个字节，仅在URG=1时才有用，指出本报文段中的紧急数据的字节数(紧急数据后就是普通数据)，即使窗口为0，也可发送紧急数据
            * 选项：长度不定，最长40字节，没有选项时，TCP的首部长度是20字节
            
    * 数据
    
* TCP可靠传输的实现
    
    * 滑动窗口：字节为单位
    
* TCP流量控制

* TCP拥塞控制

* TCP运输连接管理



#### 无连接的UDP协议

* 名称：用户数据报协议(User Datagram Protocol)
* 提供一条不可靠信道
* 数据单位：按照OSI,叫运输协议数据单元TPDU(Transport Protocol DAta Unit);在TCP/IP体系中，叫UDP用户数据报
* 特点如下：
    * 是无连接的，不需要建立连接，减少了开销和发送数据之前的时延
    * 使用尽最大努力交付，即不保证可靠交付
    * 是面向报文的，对应用层交下来的报文，既不合并也不拆分，而是保留这些报文的边界
    * 没有拥塞控制,不会因为网络出现拥塞而造成源主机的发送速率降低
    * 支持一对一、一对多、多对一、多对多的交互通信
    * 首部开销小，8个字节
* UDP的首部格式
    * 首部字段：8个字节，由四个字段组成，每个字段长度都是2个字节
        * 源端口
        * 目的端口
        * 长度：用户数据报的长度，>=8(仅仅有首部)
        * 校验和：检测用户数据报传输中是否有错
    * 数据字段
* UDP的伪首部
    * 在计算校验和时，临时要在UDP用户数据报之前增加12个字节的伪首部。校验和会校验首部 + 数据部分
    * 伪首部包括
        * 源IP地址
        * 目的IP地址
        * 全零
        * IP首部中的协议字段值，对于UDP，值为17
        * UDP用户数据报长度

#### 运输层端口号

* 服务器端使用的端口号

    * 熟知端口号/系统端口号(0~1023)：FTP(21)、DNS(53)、HTTP(80)…………
    * 登记端口号(1024~49151)：为没有熟知端口号的应用程序使用的
    
* 客户端使用的端口号(49152~65535)/短暂端口号

### 注意点

* 从IP层来说，通信的两端是两个主机，在IP数据报的首部明确标志了这两个主机的IP地址。
* 从运输层来说，通信的真正的端点并不是主机而是主机中的进程，也就是说端到端的通信，就是应用进程之间的通信
* 网络层(IP层)是为主机之间提供逻辑通信，而运输层是为应用进程之间提供端到端的逻辑通信
* 对收到的报文做差错检测，而在网络层，IP数据报首部中的检验和字段，只校验首部是否出现差错而不检查数据部分